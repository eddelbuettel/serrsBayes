<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Methanol example • serrsBayes</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Methanol example">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">serrsBayes</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Introduction.html">Introducing serrsBayes</a>
    </li>
    <li>
      <a href="../articles/Methanol.html">Methanol example</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mooresm/serrsBayes">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Methanol example</h1>
                        <h4 class="author">Matt Moores, Benjamin Moskowitz and Karen Faulds</h4>
            
            <h4 class="date">2019-04-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mooresm/serrsBayes/blob/master/vignettes/Methanol.Rmd"><code>vignettes/Methanol.Rmd</code></a></small>
      <div class="hidden name"><code>Methanol.Rmd</code></div>

    </div>

    
    
<p>There are 3 R functions available in the package <strong>serrsBayes</strong> for model-based, statistical analysis of spectroscopy:</p>
<ul>
<li><code>fitSpectraMCMC</code></li>
<li><code>fitSpectraSMC</code></li>
<li><code>fitVoigtPeaksSMC</code></li>
</ul>
<p>This vignette will provide recommendations for choosing which function to use for a given purpose. As an example, let’s say I wanted to fit a Raman spectrum of methanol. With a quick Google search, I find that there should be 4 peaks located at wavenumbers 1033 (C-O stretching), 1106 (CH3 rocking), 1149 (CH3 bending), and 1448 cm<span class="math inline">\(^{-1}\)</span>. However, we know that these peaks can shift slightly due to differences in temperature, pressure, spectrometer calibration, etc. My sample is in the liquid phase, so these peaks will not be exactly Gaussian or Lorentzian, but somewhere in the middle. On the other hand, I don’t want to wait for hours for SMC to finish running.</p>
<p>The first point to emphasise is that <code>fitSpectraMCMC</code> should <em>not</em> be used for real data. It exists mainly to illustrate the differences between MCMC and SMC algorithms, so is only of interest to computational statisticians.</p>
<p><code>fitSpectraSMC</code> is the fastest method, but can also be difficult to tune. You need to choose either Lorentzian or Gaussian broadening functions. You also need to use fixed peak locations and the results are sensitive to the choice of <code>priors$bl.smooth</code>, however if you manage to get it working for your data then there is no real reason to use <code>fitVoigtPeaksSMC</code>.</p>
<p>The main differences in <code>fitVoigtPeaksSMC</code> are as follows:</p>
<ul>
<li>There are 2 scale parameters, <span class="math inline">\(\psi_G\)</span> and <span class="math inline">\(\psi_L\)</span>, that control the full-width at half-maximum (FWHM) of the peaks. The broadening profile is a mixture of Gaussian and Lorentzian, also known as a <a href="https://en.wikipedia.org/wiki/Voigt_profile#Numeric_approximations">pseudo-Voigt function</a>.</li>
<li>The peak locations are not fixed. Instead, they are estimated as parameters of the model. This means that you need to supply informative prior distributions for the peak locations, <code>loc.mu</code> (mean) and <code>loc.sd</code> (standard deviation), in wavenumbers <span class="math inline">\(\left(\mathrm{cm}^{-1}\right)\)</span>.</li>
<li>The underlying SMC algorithm works differently. The main effect of this is that you should set <code>priors$bl.smooth = 1</code> if you are using <code>fitVoigtPeaksSMC</code>, instead of <code>priors$bl.smooth=10^11</code> or something like that. The baseline estimation is more robust and easier to tune for “difficult” spectra.</li>
<li>You do not need to set a prior for the amplitudes of the peaks (<code>beta.mu</code> and <code>beta.sd</code>). If you leave it out, then a uniform prior will be used by default. However, you can also set informative priors for the amplitude of each peak in the spectrum if that information is available.</li>
</ul>
<div id="raw-data" class="section level2">
<h2 class="hasAnchor">
<a href="#raw-data" class="anchor"></a>Raw Data</h2>
<p>The first step is always to read in the spectrum and plot it. Normally I would use the R package <strong>hyperSpec</strong> for this, but the data that we are going to use is included in the R package <strong>serrsBayes</strong>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(serrsBayes)</a></code></pre></div>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## Loading required package: truncnorm</code></pre>
<pre><code>## Loading required package: splines</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(<span class="st">"methanol"</span>, <span class="dt">package =</span> <span class="st">"serrsBayes"</span>)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">wavenumbers &lt;-<span class="st"> </span>methanol<span class="op">$</span>wavenumbers</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">spectra &lt;-<span class="st"> </span>methanol<span class="op">$</span>spectra</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">peakLocations &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1033</span>, <span class="dv">1106</span>, <span class="dv">1149</span>, <span class="dv">1448</span>)</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">nPK &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(peakLocations)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">pkIdx &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>(nPK)</a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nPK) {</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">  pkIdx[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which.min">which.min</a></span>(wavenumbers <span class="op">&lt;</span><span class="st"> </span>peakLocations[i])</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">nWL &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(wavenumbers)</a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(wavenumbers, spectra[<span class="dv">1</span>,], <span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">col=</span><span class="dv">4</span>,</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">     <span class="dt">xlab=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/expression">expression</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"Raman shift (cm"</span><span class="op">^</span>{<span class="op">-</span><span class="dv">1</span>}, <span class="st">")"</span>)), <span class="dt">ylab=</span><span class="st">"Intensity (a.u.)"</span>)</a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/points">points</a></span>(peakLocations, spectra[<span class="dv">1</span>,pkIdx], <span class="dt">cex=</span><span class="dv">2</span>, <span class="dt">col=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/text">text</a></span>(peakLocations <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">100</span>,<span class="dv">20</span>,<span class="dv">40</span>,<span class="dv">0</span>), spectra[<span class="dv">1</span>,pkIdx] <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>,<span class="dv">1400</span>,<span class="dv">700</span>,<span class="dv">700</span>), <span class="dt">labels=</span>peakLocations)</a></code></pre></div>
<div class="figure">
<img src="Methanol_files/figure-html/data-1.png" alt="Observed Raman spectrum for methanol." width="384"><p class="caption">
Observed Raman spectrum for methanol.
</p>
</div>
</div>
<div id="fitspectrasmc" class="section level2">
<h2 class="hasAnchor">
<a href="#fitspectrasmc" class="anchor"></a>fitSpectraSMC</h2>
<p>We can use exactly the same priors as given in the package README:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">lPriors &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">scale.mu=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(<span class="fl">11.6</span>) <span class="op">-</span><span class="st"> </span>(<span class="fl">0.4</span><span class="op">^</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="dt">scale.sd=</span><span class="fl">0.4</span>, <span class="dt">bl.smooth=</span><span class="dv">10</span><span class="op">^</span><span class="dv">11</span>, <span class="dt">bl.knots=</span><span class="dv">50</span>,</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">                 <span class="dt">beta.mu=</span><span class="dv">5000</span>, <span class="dt">beta.sd=</span><span class="dv">5000</span>, <span class="dt">noise.sd=</span><span class="dv">200</span>, <span class="dt">noise.nu=</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">tm &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.time">system.time</a></span>(result &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fitSpectraSMC.html">fitSpectraSMC</a></span>(wavenumbers, spectra, peakLocations, lPriors))</a></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(tm[<span class="st">"elapsed"</span>]<span class="op">/</span><span class="dv">60</span>, <span class="st">"minutes"</span>))</a></code></pre></div>
<pre><code>## [1] "2.79181666666667 minutes"</code></pre>
<p>We can see there is a problem with the model fit:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">samp.idx &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample.int</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(result<span class="op">$</span>weights), <span class="dv">200</span>, <span class="dt">prob=</span>result<span class="op">$</span>weights)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(wavenumbers, spectra[<span class="dv">1</span>,], <span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">lwd=</span><span class="dv">3</span>,</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">     <span class="dt">xlab=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/expression">expression</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"Raman shift (cm"</span><span class="op">^</span>{<span class="op">-</span><span class="dv">1</span>}, <span class="st">")"</span>)), <span class="dt">ylab=</span><span class="st">"Intensity (a.u.)"</span>)</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="cf">for</span> (pt <span class="cf">in</span> samp.idx) {</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">  bl.est &lt;-<span class="st"> </span>result<span class="op">$</span>basis <span class="op">%*%</span><span class="st"> </span>result<span class="op">$</span>alpha[,<span class="dv">1</span>,pt]</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(wavenumbers, bl.est, <span class="dt">col=</span><span class="st">"#C3000009"</span>)</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(wavenumbers, bl.est <span class="op">+</span><span class="st"> </span>result<span class="op">$</span>expFn[pt,], <span class="dt">col=</span><span class="st">"#00C30009"</span>)</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">}</a></code></pre></div>
<div class="figure">
<img src="Methanol_files/figure-html/fitSpectraBL-1.png" alt="Fitted model with Lorentzian peaks." width="384"><p class="caption">
Fitted model with Lorentzian peaks.
</p>
</div>
<p>Adjusting the priors is not going to fix this. The underlying issue is that the peak location of 1448 cm<span class="math inline">\(^{-1}\)</span> doesn’t match our observed data. Even a small difference in the location of one of the peaks can adversely effect the entire model fit. This is the kind of issue that the function <code>fitVoigtPeaksSMC</code> is designed to handle.</p>
</div>
<div id="fitvoigtpeakssmc" class="section level2">
<h2 class="hasAnchor">
<a href="#fitvoigtpeakssmc" class="anchor"></a>fitVoigtPeaksSMC</h2>
<p>The priors here are very similar to what we used for TAMRA in <a href="https://mooresm.github.io/serrsBayes/articles/Introduction.html">the other vignette</a>. However, we don’t need as many <code>bl.knots</code> because we have a narrower range of wavenumbers. Instead, we will use <code>bl.knots = 50</code>, the same as what we used for <code>fitSpectraSMC</code> above.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">lPriors2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">loc.mu=</span>peakLocations, <span class="dt">loc.sd=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">50</span>,nPK), <span class="dt">scaG.mu=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(<span class="fl">16.47</span>) <span class="op">-</span><span class="st"> </span>(<span class="fl">0.34</span><span class="op">^</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">                 <span class="dt">scaG.sd=</span><span class="fl">0.34</span>, <span class="dt">scaL.mu=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(<span class="fl">25.27</span>) <span class="op">-</span><span class="st"> </span>(<span class="fl">0.4</span><span class="op">^</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="dt">scaL.sd=</span><span class="fl">0.4</span>, <span class="dt">noise.nu=</span><span class="dv">5</span>,</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">                 <span class="dt">noise.sd=</span><span class="dv">50</span>, <span class="dt">bl.smooth=</span><span class="dv">1</span>, <span class="dt">bl.knots=</span><span class="dv">50</span>)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(<span class="st">"result2"</span>, <span class="dt">package =</span> <span class="st">"serrsBayes"</span>)</a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="cf">if</span>(<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/exists">exists</a></span>(<span class="st">"result2"</span>)) {</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">  tm2 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.time">system.time</a></span>(result2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fitVoigtPeaksSMC.html">fitVoigtPeaksSMC</a></span>(wavenumbers, spectra, lPriors2, <span class="dt">npart=</span><span class="dv">3000</span>))</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">  result2<span class="op">$</span>time &lt;-<span class="st"> </span>tm2</a>
<a class="sourceLine" id="cb10-8" data-line-number="8">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/save">save</a></span>(result2, <span class="dt">file=</span><span class="st">"Figure 2/result2.rda"</span>)</a>
<a class="sourceLine" id="cb10-9" data-line-number="9">}</a></code></pre></div>
<p><code>fitVoigtPeaksSMC</code> takes more than twice as long to fit the model, due to estimating the additional parameters. However, we obtain a much better fit to the observed spectrum:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(result2<span class="op">$</span>time[<span class="st">"elapsed"</span>]<span class="op">/</span><span class="dv">60</span>, <span class="st">"minutes"</span>))</a></code></pre></div>
<pre><code>## [1] "7.21733333333347 minutes"</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">samp.idx &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(result2<span class="op">$</span>location)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(wavenumbers, spectra[<span class="dv">1</span>,], <span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">lwd=</span><span class="dv">3</span>,</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">     <span class="dt">xlab=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/expression">expression</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"Raman shift (cm"</span><span class="op">^</span>{<span class="op">-</span><span class="dv">1</span>}, <span class="st">")"</span>)), <span class="dt">ylab=</span><span class="st">"Intensity (a.u.)"</span>)</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">samp.mat &lt;-<span class="st"> </span>resid.mat &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="dv">0</span>,<span class="dt">nrow=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(samp.idx), <span class="dt">ncol=</span>nWL)</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">samp.sigi &lt;-<span class="st"> </span>samp.lambda &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">numeric</a></span>(<span class="dt">length=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(samp.mat))</a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="cf">for</span> (pt <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(samp.idx)) {</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">  k &lt;-<span class="st"> </span>samp.idx[pt]</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">  samp.mat[pt,] &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mixedVoigt.html">mixedVoigt</a></span>(result2<span class="op">$</span>location[k,], result2<span class="op">$</span>scale_G[k,],</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">                              result2<span class="op">$</span>scale_L[k,], result2<span class="op">$</span>beta[k,], wavenumbers)</a>
<a class="sourceLine" id="cb13-10" data-line-number="10">  samp.sigi[pt] &lt;-<span class="st"> </span>result2<span class="op">$</span>sigma[k]</a>
<a class="sourceLine" id="cb13-11" data-line-number="11">  samp.lambda[pt] &lt;-<span class="st"> </span>result2<span class="op">$</span>lambda[k]</a>
<a class="sourceLine" id="cb13-12" data-line-number="12">  </a>
<a class="sourceLine" id="cb13-13" data-line-number="13">  Obsi &lt;-<span class="st"> </span>spectra[<span class="dv">1</span>,] <span class="op">-</span><span class="st"> </span>samp.mat[pt,]</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">  g0_Cal &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(Obsi) <span class="op">*</span><span class="st"> </span>samp.lambda[pt] <span class="op">*</span><span class="st"> </span>result2<span class="op">$</span>priors<span class="op">$</span>bl.precision</a>
<a class="sourceLine" id="cb13-15" data-line-number="15">  gi_Cal &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/crossprod">crossprod</a></span>(result2<span class="op">$</span>priors<span class="op">$</span>bl.basis) <span class="op">+</span><span class="st"> </span>g0_Cal</a>
<a class="sourceLine" id="cb13-16" data-line-number="16">  mi_Cal &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/vector">as.vector</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/solve">solve</a></span>(gi_Cal, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/crossprod">crossprod</a></span>(result2<span class="op">$</span>priors<span class="op">$</span>bl.basis, Obsi)))</a>
<a class="sourceLine" id="cb13-17" data-line-number="17"></a>
<a class="sourceLine" id="cb13-18" data-line-number="18">  bl.est &lt;-<span class="st"> </span>result2<span class="op">$</span>priors<span class="op">$</span>bl.basis <span class="op">%*%</span><span class="st"> </span>mi_Cal <span class="co"># smoothed residuals = estimated basline</span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19">  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(wavenumbers, bl.est, <span class="dt">col=</span><span class="st">"#C3000009"</span>)</a>
<a class="sourceLine" id="cb13-20" data-line-number="20">  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(wavenumbers, bl.est <span class="op">+</span><span class="st"> </span>samp.mat[pt,], <span class="dt">col=</span><span class="st">"#00C30009"</span>)</a>
<a class="sourceLine" id="cb13-21" data-line-number="21">  resid.mat[pt,] &lt;-<span class="st"> </span>Obsi <span class="op">-</span><span class="st"> </span>bl.est[,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb13-22" data-line-number="22">}</a></code></pre></div>
<div class="figure">
<img src="Methanol_files/figure-html/fitVoigtBL-1.png" alt="Fitted model with Voigt peaks." width="384"><p class="caption">
Fitted model with Voigt peaks.
</p>
</div>
<p>The model fit could be further improved. For example, it appears that there is a shoulder peak around 1550 cm<span class="math inline">\(^{-1}\)</span>. However, we can see that the posterior distribution for the fourth peak location is very far away from the theoretical value of 1448:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>) {</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/hist">hist</a></span>(result2<span class="op">$</span>location[,j], <span class="dt">main=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"Peak"</span>,j),</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">       <span class="dt">xlab=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/expression">expression</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"Peak location (cm"</span><span class="op">^</span>{<span class="op">-</span><span class="dv">1</span>}, <span class="st">")"</span>)),</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">       <span class="dt">freq=</span><span class="ot">FALSE</span>, <span class="dt">xlim=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/range">range</a></span>(result2<span class="op">$</span>location[,j], peakLocations[j]))</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/density">density</a></span>(result2<span class="op">$</span>location[,j]), <span class="dt">col=</span><span class="dv">4</span>, <span class="dt">lty=</span><span class="dv">2</span>, <span class="dt">lwd=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/abline">abline</a></span>(<span class="dt">v=</span>peakLocations[j], <span class="dt">col=</span><span class="dv">2</span>, <span class="dt">lty=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">}</a></code></pre></div>
<div class="figure">
<img src="Methanol_files/figure-html/peakLoc-1.png" alt="Posteriors for the peak locations." width="700"><img src="Methanol_files/figure-html/peakLoc-2.png" alt="Posteriors for the peak locations." width="700"><img src="Methanol_files/figure-html/peakLoc-3.png" alt="Posteriors for the peak locations." width="700"><img src="Methanol_files/figure-html/peakLoc-4.png" alt="Posteriors for the peak locations." width="700"><p class="caption">
Posteriors for the peak locations.
</p>
</div>
<p>This explains why the results from <code>fitSpectraSMC</code> were so poor. You really need to have very precise information about all of the peak locations in order for that function to perform well. Otherwise, <code>fitVoigtPeaksSMC</code> will usually give much better fit to the observed spectrum.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#raw-data">Raw Data</a></li>
      <li><a href="#fitspectrasmc">fitSpectraSMC</a></li>
      <li><a href="#fitvoigtpeakssmc">fitVoigtPeaksSMC</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Matt Moores, Jake Carson, Mark Girolami, Engineering and Physical Sciences Research Council.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
