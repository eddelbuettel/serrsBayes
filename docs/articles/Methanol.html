<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Methanol example • serrsBayes</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Methanol example">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">serrsBayes</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Introduction.html">Introducing serrsBayes</a>
    </li>
    <li>
      <a href="../articles/Methanol.html">Methanol example</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mooresm/serrsBayes">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Methanol example</h1>
                        <h4 class="author">Matt Moores, Benjamin Moskowitz and Karen Faulds</h4>
            
            <h4 class="date">2020-02-06</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mooresm/serrsBayes/blob/master/vignettes/Methanol.Rmd"><code>vignettes/Methanol.Rmd</code></a></small>
      <div class="hidden name"><code>Methanol.Rmd</code></div>

    </div>

    
    
<p>There are 3 R functions available in the package <strong>serrsBayes</strong> for model-based, statistical analysis of spectroscopy:</p>
<ul>
<li><code>fitSpectraMCMC</code></li>
<li><code>fitSpectraSMC</code></li>
<li><code>fitVoigtPeaksSMC</code></li>
</ul>
<p>This vignette will provide recommendations for choosing which function to use for a given purpose. As an example, let’s say I wanted to fit a Raman spectrum of methanol. With a quick Google search, I find that there should be 4 peaks located at wavenumbers 1033 (C-O stretching), 1106 (CH3 rocking), 1149 (CH3 bending), and 1448 cm<span class="math inline">\(^{-1}\)</span>. However, we know that these peaks can shift slightly due to differences in temperature, pressure, spectrometer calibration, etc. My sample is in the liquid phase, so these peaks will not be exactly Gaussian or Lorentzian, but somewhere in the middle. On the other hand, I don’t want to wait for hours for SMC to finish running.</p>
<p>The first point to emphasise is that <code>fitSpectraMCMC</code> should <em>not</em> be used for real data. It exists mainly to illustrate the differences between MCMC and SMC algorithms, so is only of interest to computational statisticians.</p>
<p><code>fitSpectraSMC</code> is the fastest method, but can also be difficult to tune. You need to choose either Lorentzian or Gaussian broadening functions. You also need to use fixed peak locations and the results are sensitive to the choice of <code>priors$bl.smooth</code>, however if you manage to get it working for your data then there is no real reason to use <code>fitVoigtPeaksSMC</code>.</p>
<p>The main differences in <code>fitVoigtPeaksSMC</code> are as follows:</p>
<ul>
<li>There are 2 scale parameters, <span class="math inline">\(\psi_G\)</span> and <span class="math inline">\(\psi_L\)</span>, that control the full-width at half-maximum (FWHM) of the peaks. The broadening profile is a mixture of Gaussian and Lorentzian, also known as a <a href="https://en.wikipedia.org/wiki/Voigt_profile#Numeric_approximations">pseudo-Voigt function</a>.</li>
<li>The peak locations are not fixed. Instead, they are estimated as parameters of the model. This means that you need to supply informative prior distributions for the peak locations, <code>loc.mu</code> (mean) and <code>loc.sd</code> (standard deviation), in wavenumbers <span class="math inline">\(\left(\mathrm{cm}^{-1}\right)\)</span>.</li>
<li>The underlying SMC algorithm works differently. The main effect of this is that you should set <code>priors$bl.smooth = 1</code> if you are using <code>fitVoigtPeaksSMC</code>, instead of <code>priors$bl.smooth=10^11</code> or something like that. The baseline estimation is more robust and easier to tune for “difficult” spectra.</li>
<li>You do not need to set a prior for the amplitudes of the peaks (<code>beta.mu</code> and <code>beta.sd</code>). If you leave it out, then a uniform prior will be used by default. However, you can also set informative priors for the amplitude of each peak in the spectrum if that information is available.</li>
</ul>
<div id="raw-data" class="section level2">
<h2 class="hasAnchor">
<a href="#raw-data" class="anchor"></a>Raw Data</h2>
<p>The first step is always to read in the spectrum and plot it. Normally I would use the R package <strong>hyperSpec</strong> for this, but the data that we are going to use is included in the R package <strong>serrsBayes</strong>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(serrsBayes)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"methanol"</span>, <span class="dt">package =</span> <span class="st">"serrsBayes"</span>)</a>
<a class="sourceLine" id="cb1-3" title="3">wavenumbers &lt;-<span class="st"> </span>methanol<span class="op">$</span>wavenumbers</a>
<a class="sourceLine" id="cb1-4" title="4">spectra &lt;-<span class="st"> </span>methanol<span class="op">$</span>spectra</a>
<a class="sourceLine" id="cb1-5" title="5"></a>
<a class="sourceLine" id="cb1-6" title="6">peakLocations &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1033</span>, <span class="dv">1106</span>, <span class="dv">1149</span>, <span class="dv">1448</span>)</a>
<a class="sourceLine" id="cb1-7" title="7">nPK &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(peakLocations)</a>
<a class="sourceLine" id="cb1-8" title="8">pkIdx &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>(nPK)</a>
<a class="sourceLine" id="cb1-9" title="9"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nPK) {</a>
<a class="sourceLine" id="cb1-10" title="10">  pkIdx[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span>(wavenumbers <span class="op">&lt;</span><span class="st"> </span>peakLocations[i])</a>
<a class="sourceLine" id="cb1-11" title="11">}</a>
<a class="sourceLine" id="cb1-12" title="12">nWL &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(wavenumbers)</a>
<a class="sourceLine" id="cb1-13" title="13"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(wavenumbers, spectra[<span class="dv">1</span>,], <span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">col=</span><span class="dv">4</span>,</a>
<a class="sourceLine" id="cb1-14" title="14">     <span class="dt">xlab=</span><span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Raman shift (cm"</span><span class="op">^</span>{<span class="op">-</span><span class="dv">1</span>}, <span class="st">")"</span>)), <span class="dt">ylab=</span><span class="st">"Intensity (a.u.)"</span>, <span class="dt">main=</span><span class="st">"Observed Raman spectrum for methanol"</span>)</a>
<a class="sourceLine" id="cb1-15" title="15"><span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(peakLocations, spectra[<span class="dv">1</span>,pkIdx], <span class="dt">cex=</span><span class="dv">2</span>, <span class="dt">col=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb1-16" title="16"><span class="kw"><a href="https://rdrr.io/r/graphics/text.html">text</a></span>(peakLocations <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">100</span>,<span class="dv">20</span>,<span class="dv">40</span>,<span class="dv">0</span>), spectra[<span class="dv">1</span>,pkIdx] <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">700</span>,<span class="dv">400</span>,<span class="dv">700</span>), <span class="dt">labels=</span>peakLocations)</a></code></pre></div>
<p><img src="Methanol_files/figure-html/data-1.png" width="576"></p>
</div>
<div id="fitspectrasmc" class="section level2">
<h2 class="hasAnchor">
<a href="#fitspectrasmc" class="anchor"></a>fitSpectraSMC</h2>
<p>We can use exactly the same priors as given in the package README:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">lPriors &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">scale.mu=</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">11.6</span>) <span class="op">-</span><span class="st"> </span>(<span class="fl">0.4</span><span class="op">^</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="dt">scale.sd=</span><span class="fl">0.4</span>, <span class="dt">bl.smooth=</span><span class="dv">10</span><span class="op">^</span><span class="dv">11</span>, <span class="dt">bl.knots=</span><span class="dv">50</span>,</a>
<a class="sourceLine" id="cb2-2" title="2">                 <span class="dt">beta.mu=</span><span class="dv">5000</span>, <span class="dt">beta.sd=</span><span class="dv">5000</span>, <span class="dt">noise.sd=</span><span class="dv">200</span>, <span class="dt">noise.nu=</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb2-3" title="3">tm &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(result &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fitSpectraSMC.html">fitSpectraSMC</a></span>(wavenumbers, spectra, peakLocations, lPriors))</a></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(tm[<span class="st">"elapsed"</span>]<span class="op">/</span><span class="dv">60</span>, <span class="st">"minutes"</span>))</a></code></pre></div>
<pre><code>## [1] "1.616 minutes"</code></pre>
<p>We can see there is a problem with the model fit:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">samp.idx &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(result<span class="op">$</span>weights), <span class="dv">200</span>, <span class="dt">prob=</span>result<span class="op">$</span>weights)</a>
<a class="sourceLine" id="cb5-2" title="2"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(wavenumbers, spectra[<span class="dv">1</span>,], <span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">lwd=</span><span class="dv">3</span>,</a>
<a class="sourceLine" id="cb5-3" title="3">     <span class="dt">xlab=</span><span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Raman shift (cm"</span><span class="op">^</span>{<span class="op">-</span><span class="dv">1</span>}, <span class="st">")"</span>)), <span class="dt">ylab=</span><span class="st">"Intensity (a.u.)"</span>, <span class="dt">main=</span><span class="st">"Fitted model with Lorentzian peaks"</span>)</a>
<a class="sourceLine" id="cb5-4" title="4"><span class="cf">for</span> (pt <span class="cf">in</span> samp.idx) {</a>
<a class="sourceLine" id="cb5-5" title="5">  bl.est &lt;-<span class="st"> </span>result<span class="op">$</span>basis <span class="op">%*%</span><span class="st"> </span>result<span class="op">$</span>alpha[,<span class="dv">1</span>,pt]</a>
<a class="sourceLine" id="cb5-6" title="6">  <span class="kw"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(wavenumbers, bl.est, <span class="dt">col=</span><span class="st">"#C3000009"</span>)</a>
<a class="sourceLine" id="cb5-7" title="7">  <span class="kw"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(wavenumbers, bl.est <span class="op">+</span><span class="st"> </span>result<span class="op">$</span>expFn[pt,], <span class="dt">col=</span><span class="st">"#00C30009"</span>)</a>
<a class="sourceLine" id="cb5-8" title="8">}</a></code></pre></div>
<p><img src="Methanol_files/figure-html/fitSpectraBL-1.png" width="576"></p>
<p>Adjusting the priors is not going to fix this. The underlying issue is that the peak location of 1448 cm<span class="math inline">\(^{-1}\)</span> doesn’t match our observed data. Even a small difference in the location of one of the peaks can adversely effect the entire model fit. This is the kind of issue that the function <code>fitVoigtPeaksSMC</code> is designed to handle.</p>
</div>
<div id="fitvoigtpeakssmc" class="section level2">
<h2 class="hasAnchor">
<a href="#fitvoigtpeakssmc" class="anchor"></a>fitVoigtPeaksSMC</h2>
<p>The priors here are very similar to what we used for TAMRA in <a href="https://mooresm.github.io/serrsBayes/articles/Introduction.html">the other vignette</a>. However, we don’t need as many <code>bl.knots</code> because we have a narrower range of wavenumbers. Instead, we will use <code>bl.knots = 50</code>, the same as what we used for <code>fitSpectraSMC</code> above.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">lPriors2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">loc.mu=</span>peakLocations, <span class="dt">loc.sd=</span><span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">50</span>,nPK), <span class="dt">scaG.mu=</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">16.47</span>) <span class="op">-</span><span class="st"> </span>(<span class="fl">0.34</span><span class="op">^</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb6-2" title="2">                 <span class="dt">scaG.sd=</span><span class="fl">0.34</span>, <span class="dt">scaL.mu=</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">25.27</span>) <span class="op">-</span><span class="st"> </span>(<span class="fl">0.4</span><span class="op">^</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="dt">scaL.sd=</span><span class="fl">0.4</span>, <span class="dt">noise.nu=</span><span class="dv">5</span>,</a>
<a class="sourceLine" id="cb6-3" title="3">                 <span class="dt">noise.sd=</span><span class="dv">50</span>, <span class="dt">bl.smooth=</span><span class="dv">1</span>, <span class="dt">bl.knots=</span><span class="dv">50</span>)</a>
<a class="sourceLine" id="cb6-4" title="4"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"result2"</span>, <span class="dt">package =</span> <span class="st">"serrsBayes"</span>)</a>
<a class="sourceLine" id="cb6-5" title="5"><span class="cf">if</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/exists.html">exists</a></span>(<span class="st">"result2"</span>)) {</a>
<a class="sourceLine" id="cb6-6" title="6">  tm2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(result2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fitVoigtPeaksSMC.html">fitVoigtPeaksSMC</a></span>(wavenumbers, spectra, lPriors2, <span class="dt">npart=</span><span class="dv">3000</span>))</a>
<a class="sourceLine" id="cb6-7" title="7">  result2<span class="op">$</span>time &lt;-<span class="st"> </span>tm2</a>
<a class="sourceLine" id="cb6-8" title="8">  <span class="kw"><a href="https://rdrr.io/r/base/save.html">save</a></span>(result2, <span class="dt">file=</span><span class="st">"Figure 2/result2.rda"</span>)</a>
<a class="sourceLine" id="cb6-9" title="9">}</a></code></pre></div>
<p><code>fitVoigtPeaksSMC</code> takes more than twice as long to fit the model, due to estimating the additional parameters. However, we obtain a much better fit to the observed spectrum:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(result2<span class="op">$</span>time[<span class="st">"elapsed"</span>]<span class="op">/</span><span class="dv">60</span>, <span class="st">"minutes"</span>))</a></code></pre></div>
<pre><code>## [1] "7.21733333333347 minutes"</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">samp.idx &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(result2<span class="op">$</span>location)</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(wavenumbers, spectra[<span class="dv">1</span>,], <span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">lwd=</span><span class="dv">3</span>,</a>
<a class="sourceLine" id="cb9-3" title="3">     <span class="dt">xlab=</span><span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Raman shift (cm"</span><span class="op">^</span>{<span class="op">-</span><span class="dv">1</span>}, <span class="st">")"</span>)), <span class="dt">ylab=</span><span class="st">"Intensity (a.u.)"</span>, <span class="dt">main=</span><span class="st">"Fitted model with Voigt peaks"</span>)</a>
<a class="sourceLine" id="cb9-4" title="4">samp.mat &lt;-<span class="st"> </span>resid.mat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="dv">0</span>,<span class="dt">nrow=</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(samp.idx), <span class="dt">ncol=</span>nWL)</a>
<a class="sourceLine" id="cb9-5" title="5">samp.sigi &lt;-<span class="st"> </span>samp.lambda &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>(<span class="dt">length=</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(samp.mat))</a>
<a class="sourceLine" id="cb9-6" title="6"><span class="cf">for</span> (pt <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(samp.idx)) {</a>
<a class="sourceLine" id="cb9-7" title="7">  k &lt;-<span class="st"> </span>samp.idx[pt]</a>
<a class="sourceLine" id="cb9-8" title="8">  samp.mat[pt,] &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mixedVoigt.html">mixedVoigt</a></span>(result2<span class="op">$</span>location[k,], result2<span class="op">$</span>scale_G[k,],</a>
<a class="sourceLine" id="cb9-9" title="9">                              result2<span class="op">$</span>scale_L[k,], result2<span class="op">$</span>beta[k,], wavenumbers)</a>
<a class="sourceLine" id="cb9-10" title="10">  samp.sigi[pt] &lt;-<span class="st"> </span>result2<span class="op">$</span>sigma[k]</a>
<a class="sourceLine" id="cb9-11" title="11">  samp.lambda[pt] &lt;-<span class="st"> </span>result2<span class="op">$</span>lambda[k]</a>
<a class="sourceLine" id="cb9-12" title="12">  </a>
<a class="sourceLine" id="cb9-13" title="13">  Obsi &lt;-<span class="st"> </span>spectra[<span class="dv">1</span>,] <span class="op">-</span><span class="st"> </span>samp.mat[pt,]</a>
<a class="sourceLine" id="cb9-14" title="14">  g0_Cal &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(Obsi) <span class="op">*</span><span class="st"> </span>samp.lambda[pt] <span class="op">*</span><span class="st"> </span>result2<span class="op">$</span>priors<span class="op">$</span>bl.precision</a>
<a class="sourceLine" id="cb9-15" title="15">  gi_Cal &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span>(result2<span class="op">$</span>priors<span class="op">$</span>bl.basis) <span class="op">+</span><span class="st"> </span>g0_Cal</a>
<a class="sourceLine" id="cb9-16" title="16">  mi_Cal &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/solve.html">solve</a></span>(gi_Cal, <span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span>(result2<span class="op">$</span>priors<span class="op">$</span>bl.basis, Obsi)))</a>
<a class="sourceLine" id="cb9-17" title="17"></a>
<a class="sourceLine" id="cb9-18" title="18">  bl.est &lt;-<span class="st"> </span>result2<span class="op">$</span>priors<span class="op">$</span>bl.basis <span class="op">%*%</span><span class="st"> </span>mi_Cal <span class="co"># smoothed residuals = estimated basline</span></a>
<a class="sourceLine" id="cb9-19" title="19">  <span class="kw"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(wavenumbers, bl.est, <span class="dt">col=</span><span class="st">"#C3000009"</span>)</a>
<a class="sourceLine" id="cb9-20" title="20">  <span class="kw"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(wavenumbers, bl.est <span class="op">+</span><span class="st"> </span>samp.mat[pt,], <span class="dt">col=</span><span class="st">"#00C30009"</span>)</a>
<a class="sourceLine" id="cb9-21" title="21">  resid.mat[pt,] &lt;-<span class="st"> </span>Obsi <span class="op">-</span><span class="st"> </span>bl.est[,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb9-22" title="22">}</a></code></pre></div>
<p><img src="Methanol_files/figure-html/fitVoigtBL-1.png" width="576"></p>
<p>The model fit could be further improved. For example, it appears that there is a shoulder peak around 1550 cm<span class="math inline">\(^{-1}\)</span>. However, we can see that the posterior distribution for the fourth peak location is very far away from the theoretical value of 1448:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nPK) {</a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="kw"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span>(result2<span class="op">$</span>location[,j], <span class="dt">main=</span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Peak"</span>,j),</a>
<a class="sourceLine" id="cb10-3" title="3">       <span class="dt">xlab=</span><span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Peak location (cm"</span><span class="op">^</span>{<span class="op">-</span><span class="dv">1</span>}, <span class="st">")"</span>)),</a>
<a class="sourceLine" id="cb10-4" title="4">       <span class="dt">freq=</span><span class="ot">FALSE</span>, <span class="dt">xlim=</span><span class="kw"><a href="https://rdrr.io/r/base/range.html">range</a></span>(result2<span class="op">$</span>location[,j], peakLocations[j]))</a>
<a class="sourceLine" id="cb10-5" title="5">  <span class="kw"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/density.html">density</a></span>(result2<span class="op">$</span>location[,j]), <span class="dt">col=</span><span class="dv">4</span>, <span class="dt">lty=</span><span class="dv">2</span>, <span class="dt">lwd=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb10-6" title="6">  <span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">v=</span>peakLocations[j], <span class="dt">col=</span><span class="dv">2</span>, <span class="dt">lty=</span><span class="dv">3</span>, <span class="dt">lwd=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb10-7" title="7">}</a></code></pre></div>
<div class="figure">
<img src="Methanol_files/figure-html/peakLoc-1.png" alt="Posteriors for the peak locations." width="288"><img src="Methanol_files/figure-html/peakLoc-2.png" alt="Posteriors for the peak locations." width="288"><img src="Methanol_files/figure-html/peakLoc-3.png" alt="Posteriors for the peak locations." width="288"><img src="Methanol_files/figure-html/peakLoc-4.png" alt="Posteriors for the peak locations." width="288"><p class="caption">
Posteriors for the peak locations.
</p>
</div>
<p>This explains why the results from <code>fitSpectraSMC</code> were so poor. You really need to have very precise information about all of the peak locations in order for that function to perform well. Otherwise, <code>fitVoigtPeaksSMC</code> will usually give much better fit to the observed spectrum.</p>
</div>
<div id="fitspectrasmc-redux" class="section level2">
<h2 class="hasAnchor">
<a href="#fitspectrasmc-redux" class="anchor"></a>fitSpectraSMC, redux</h2>
<p>We can use the posterior from <code>fitVoigtPeaksSMC</code> to obtain priors for running <code>fitSpectraSMC</code>. This can be useful, for example, for fitting the model to multiple datasets that were obtained under the same experimental conditions.</p>
<p>The first question is whether to use Lorentzian or Gaussian broadening functions. We can transform the posteriors for <span class="math inline">\(\psi_G\)</span> and <span class="math inline">\(\psi_L\)</span> to obtain a number <span class="math inline">\(\eta\)</span> between 0 and 1 for each peak, where 0 implies pure Gaussian and 1 implies Lorentzian. The <a href="https://en.wikipedia.org/wiki/Voigt_profile#Pseudo-Voigt_approximation">Wikipedia page</a> provides the equations <span class="citation">(Thompson, Cox, and Hastings 1987)</span>: <span class="math display">\[
f_G = 2\psi_G\sqrt{2\log\{2\}} \\
f_L = 2\psi_L \\
f_V \approx 0.5346 f_L + \sqrt{0.2166f_L^2 + f_G^2} \\
f_{total} \approx \left(f_G^5 + 2.69269f_G^4 f_L + 2.42843f_G^3 f_L^2 + 4.47163f_G^2 f_L^3 + 0.07842f_G f_L^4 + f_L^5 \right)^{1/5} \\
\eta \approx 1.33603 \frac{f_L}{f_{total}} - 0.47719 \left(\frac{f_L}{f_{total}} \right)^2 + 0.11116 \left(\frac{f_L}{f_{total}} \right)^3
\]</span> The above equations are implemented by the function <code>getVoigtParam</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">nPart &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(result2<span class="op">$</span>beta)</a>
<a class="sourceLine" id="cb11-2" title="2">result2<span class="op">$</span>voigt &lt;-<span class="st"> </span>result2<span class="op">$</span>FWHM &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="dt">nrow=</span>nPart, <span class="dt">ncol=</span>nPK)</a>
<a class="sourceLine" id="cb11-3" title="3"><span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nPart) {</a>
<a class="sourceLine" id="cb11-4" title="4">  result2<span class="op">$</span>voigt[k,] &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getVoigtParam.html">getVoigtParam</a></span>(result2<span class="op">$</span>scale_G[k,], result2<span class="op">$</span>scale_L[k,])</a>
<a class="sourceLine" id="cb11-5" title="5">  f_G &lt;-<span class="st"> </span><span class="dv">2</span><span class="op">*</span>result2<span class="op">$</span>scale_G[k,]<span class="op">*</span><span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="dv">2</span><span class="op">*</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb11-6" title="6">  f_L &lt;-<span class="st"> </span><span class="dv">2</span><span class="op">*</span>result2<span class="op">$</span>scale_L[k,]</a>
<a class="sourceLine" id="cb11-7" title="7">  result2<span class="op">$</span>FWHM[k,] &lt;-<span class="st"> </span><span class="fl">0.5346</span><span class="op">*</span>f_L <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">0.2166</span><span class="op">*</span>f_L<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>f_G<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb11-8" title="8">}</a>
<a class="sourceLine" id="cb11-9" title="9"><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nPK) {</a>
<a class="sourceLine" id="cb11-10" title="10">  <span class="kw"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span>(result2<span class="op">$</span>voigt[,j], <span class="dt">main=</span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Peak"</span>,j),</a>
<a class="sourceLine" id="cb11-11" title="11">       <span class="dt">xlab=</span><span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(eta), <span class="dt">freq=</span><span class="ot">FALSE</span>, <span class="dt">xlim=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb11-12" title="12">  <span class="kw"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/density.html">density</a></span>(result2<span class="op">$</span>voigt[,j]), <span class="dt">col=</span><span class="dv">4</span>, <span class="dt">lty=</span><span class="dv">2</span>, <span class="dt">lwd=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb11-13" title="13">}</a></code></pre></div>
<p><img src="Methanol_files/figure-html/voigt-1.png" width="288"><img src="Methanol_files/figure-html/voigt-2.png" width="288"><img src="Methanol_files/figure-html/voigt-3.png" width="288"><img src="Methanol_files/figure-html/voigt-4.png" width="288"></p>
<p>The two largest peaks definitely look Lorentzian, while there is more uncertainty about the line shape for the smaller peaks. This gives us confidence that <code>fitSpectraSMC</code> should be able to give us a good fit to the data, as long as we get the peak locations closer to the correct values. We can also use moment matching to set informative priors for the amplitudes:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">lPriors3 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">scale.mu=</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">11.6</span>) <span class="op">-</span><span class="st"> </span>(<span class="fl">0.4</span><span class="op">^</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="dt">scale.sd=</span><span class="fl">0.4</span>, <span class="dt">bl.smooth=</span><span class="dv">10</span><span class="op">^</span><span class="dv">11</span>, <span class="dt">bl.knots=</span><span class="dv">50</span>, <span class="dt">noise.sd=</span><span class="dv">200</span>, <span class="dt">noise.nu=</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb12-2" title="2">lPriors3<span class="op">$</span>beta.mu &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(result2<span class="op">$</span>beta)</a>
<a class="sourceLine" id="cb12-3" title="3">lPriors3<span class="op">$</span>beta.sd &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span>(result2<span class="op">$</span>beta)</a>
<a class="sourceLine" id="cb12-4" title="4">pkLocNew &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(result2<span class="op">$</span>location), <span class="dv">1550</span>)</a>
<a class="sourceLine" id="cb12-5" title="5">tm3 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(result3 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fitSpectraSMC.html">fitSpectraSMC</a></span>(wavenumbers, spectra, pkLocNew, lPriors3, <span class="dt">npart=</span><span class="dv">2000</span>))</a></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(tm3[<span class="st">"elapsed"</span>]<span class="op">/</span><span class="dv">60</span>, <span class="st">"minutes"</span>))</a></code></pre></div>
<pre><code>## [1] "0.300166666666667 minutes"</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">samp.idx &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(result3<span class="op">$</span>weights), <span class="dv">200</span>, <span class="dt">prob=</span>result3<span class="op">$</span>weights)</a>
<a class="sourceLine" id="cb15-2" title="2"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(wavenumbers, spectra[<span class="dv">1</span>,], <span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">lwd=</span><span class="dv">3</span>,</a>
<a class="sourceLine" id="cb15-3" title="3">     <span class="dt">xlab=</span><span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Raman shift (cm"</span><span class="op">^</span>{<span class="op">-</span><span class="dv">1</span>}, <span class="st">")"</span>)), <span class="dt">ylab=</span><span class="st">"Intensity (a.u.)"</span>, <span class="dt">main=</span><span class="st">"Fitted model with informative priors"</span>)</a>
<a class="sourceLine" id="cb15-4" title="4"><span class="cf">for</span> (pt <span class="cf">in</span> samp.idx) {</a>
<a class="sourceLine" id="cb15-5" title="5">  bl.est &lt;-<span class="st"> </span>result3<span class="op">$</span>basis <span class="op">%*%</span><span class="st"> </span>result3<span class="op">$</span>alpha[,<span class="dv">1</span>,pt]</a>
<a class="sourceLine" id="cb15-6" title="6">  <span class="kw"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(wavenumbers, bl.est, <span class="dt">col=</span><span class="st">"#C3000009"</span>)</a>
<a class="sourceLine" id="cb15-7" title="7">  <span class="kw"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(wavenumbers, bl.est <span class="op">+</span><span class="st"> </span>result3<span class="op">$</span>expFn[pt,], <span class="dt">col=</span><span class="st">"#00C30009"</span>)</a>
<a class="sourceLine" id="cb15-8" title="8">}</a>
<a class="sourceLine" id="cb15-9" title="9"><span class="kw"><a href="https://rdrr.io/r/graphics/rug.html">rug</a></span>(pkLocNew, <span class="dt">col=</span><span class="dv">4</span>, <span class="dt">lwd=</span><span class="dv">2</span>)</a></code></pre></div>
<p><img src="Methanol_files/figure-html/fitRedux-1.png" width="576"></p>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-Thompson1987">
<p>Thompson, P., D. E. Cox, and J. B. Hastings. 1987. “Rietveld Refinement of Debye-Scherrer Synchrotron X-Ray Data from <span class="math inline">\(Al_2O_3\)</span>.” <em>J. Appl. Crystallogr.</em> 20 (2): 79–83. <a href="https://doi.org/10.1107/S0021889887087090">https://doi.org/10.1107/S0021889887087090</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#raw-data">Raw Data</a></li>
      <li><a href="#fitspectrasmc">fitSpectraSMC</a></li>
      <li><a href="#fitvoigtpeakssmc">fitVoigtPeaksSMC</a></li>
      <li><a href="#fitspectrasmc-redux">fitSpectraSMC, redux</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Matt Moores, Jake Carson, Mark Girolami, Engineering and Physical Sciences Research Council.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
