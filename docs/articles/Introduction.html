<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introducing serrsBayes • serrsBayes</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introducing serrsBayes">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">serrsBayes</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Introduction.html">Introducing serrsBayes</a>
    </li>
    <li>
      <a href="../articles/Methanol.html">Methanol example</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mooresm/serrsBayes">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Introducing serrsBayes</h1>
                        <h4 class="author">Matt Moores</h4>
            
            <h4 class="date">2020-02-06</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mooresm/serrsBayes/blob/master/vignettes/Introduction.Rmd"><code>vignettes/Introduction.Rmd</code></a></small>
      <div class="hidden name"><code>Introduction.Rmd</code></div>

    </div>

    
    
<p>The R package <strong>serrsBayes</strong> uses a sequential Monte Carlo (SMC) algorithm <span class="citation">(Del Moral, Doucet, and Jasra 2006)</span> to separate an observed spectrum into 3 components: the peaks <span class="math inline">\(s_i(\tilde\nu)\)</span>; baseline <span class="math inline">\(\xi_i(\tilde\nu)\)</span>; and additive white noise <span class="math inline">\(\epsilon_{i,j} \sim \mathcal{N}(0, \sigma^2_\epsilon)\)</span>: <span class="math display">\[
\mathbf{y}_i = \xi_i(\tilde\nu) + s_i(\tilde\nu) + \boldsymbol\epsilon_i
\]</span> This is a type of <em>functional data analysis</em> <span class="citation">(Ramsay, Hooker, and Graves 2009)</span>, since the discretised spectrum <span class="math inline">\(\mathbf{y}_i\)</span> is represented using latent (unobserved), continuous functions. The background fluorescence <span class="math inline">\(\xi_i(\tilde\nu)\)</span> is estimated using a penalised B-spline <span class="citation">(Wood 2017)</span>, while the peaks can be modelled as Gaussian, Lorentzian, or pseudo-Voigt functions.</p>
<p>The Voigt function is a <em>convolution</em> of a Gaussian and a Lorentzian: <span class="math inline">\(f_V(\nu_j) = (f_G * f_L)(\nu_j)\)</span>. It has an additional parameter <span class="math inline">\(\eta_p\)</span> that equals 0 for pure Gaussian and 1 for Lorentzian: <span class="math display">\[
s_i(\nu_j) = \sum_{p=1}^P A_{i,p} f_V(\nu_j ; \ell_p, \varphi_p, \eta_p) 
\]</span> where <span class="math inline">\(A_{i,p}\)</span> is the <em>amplitude</em> of peak <span class="math inline">\(p\)</span>; <span class="math inline">\(\ell_p\)</span> is the peak <em>location</em>; and <span class="math inline">\(\varphi_p\)</span> is the <em>broadening</em>. The horizontal axis of a Raman spectrum is measured in <em>wavenumbers</em> <span class="math inline">\(\nu_j \in \Delta\tilde\nu\)</span>, with units of inverse centimetres (cm<span class="math inline">\(^{-1}\)</span>). The vertical axis is measured in arbitrary units (a.u.), since the <em>intensity</em> of the Raman signal depends on the properties of the spectrometer. This functional model is explained further in our paper, <span class="citation">Moores et al. (2016)</span>.</p>
<div id="data" class="section level2">
<h2 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h2>
<p>This example of surface-enhanced Raman spectroscopy (SERS) was originally published by <span class="citation">Gracie et al. (2016)</span>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(serrsBayes)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"lsTamra"</span>, <span class="dt">package =</span> <span class="st">"serrsBayes"</span>)</a>
<a class="sourceLine" id="cb1-3" title="3">wavenumbers &lt;-<span class="st"> </span>lsTamra<span class="op">$</span>wavenumbers</a>
<a class="sourceLine" id="cb1-4" title="4">spectra &lt;-<span class="st"> </span>lsTamra<span class="op">$</span>spectra</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(wavenumbers, spectra[<span class="dv">1</span>,], <span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">col=</span><span class="dv">4</span>, <span class="dt">main=</span><span class="st">"Raman Spectrum of TAMRA+DNA"</span>,</a>
<a class="sourceLine" id="cb1-6" title="6">     <span class="dt">xlab=</span><span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Raman shift (cm"</span><span class="op">^</span>{<span class="op">-</span><span class="dv">1</span>}, <span class="st">")"</span>)), <span class="dt">ylab=</span><span class="st">"Intensity (a.u.)"</span>)</a></code></pre></div>
<p><img src="Introduction_files/figure-html/data-1.png" width="576"></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">nWL &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(wavenumbers)</a></code></pre></div>
</div>
<div id="priors" class="section level2">
<h2 class="hasAnchor">
<a href="#priors" class="anchor"></a>Priors</h2>
<p>We will use the same priors that were described in the paper <span class="citation">(Moores et al. 2016)</span>, including the TD-DFT peak locations from <span class="citation">Watanabe et al. (2005)</span>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">peakLocations &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">615</span>, <span class="dv">631</span>, <span class="dv">664</span>, <span class="dv">673</span>, <span class="dv">702</span>, <span class="dv">705</span>, <span class="dv">771</span>, <span class="dv">819</span>, <span class="dv">895</span>, <span class="dv">923</span>, <span class="dv">1014</span>,</a>
<a class="sourceLine" id="cb3-2" title="2">                   <span class="dv">1047</span>, <span class="dv">1049</span>, <span class="dv">1084</span>, <span class="dv">1125</span>, <span class="dv">1175</span>, <span class="dv">1192</span>, <span class="dv">1273</span>, <span class="dv">1291</span>, <span class="dv">1307</span>, <span class="dv">1351</span>, <span class="dv">1388</span>, <span class="dv">1390</span>,</a>
<a class="sourceLine" id="cb3-3" title="3">                   <span class="dv">1419</span>, <span class="dv">1458</span>, <span class="dv">1505</span>, <span class="dv">1530</span>, <span class="dv">1577</span>, <span class="dv">1601</span>, <span class="dv">1615</span>, <span class="dv">1652</span>, <span class="dv">1716</span>)</a>
<a class="sourceLine" id="cb3-4" title="4">nPK &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(peakLocations)</a>
<a class="sourceLine" id="cb3-5" title="5">priors &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">loc.mu=</span>peakLocations, <span class="dt">loc.sd=</span><span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">50</span>,nPK), <span class="dt">scaG.mu=</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">16.47</span>) <span class="op">-</span><span class="st"> </span>(<span class="fl">0.34</span><span class="op">^</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb3-6" title="6">               <span class="dt">scaG.sd=</span><span class="fl">0.34</span>, <span class="dt">scaL.mu=</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">25.27</span>) <span class="op">-</span><span class="st"> </span>(<span class="fl">0.4</span><span class="op">^</span><span class="dv">2</span>)<span class="op">/</span><span class="dv">2</span>, <span class="dt">scaL.sd=</span><span class="fl">0.4</span>, <span class="dt">noise.nu=</span><span class="dv">5</span>, <span class="dt">noise.sd=</span><span class="dv">50</span>,</a>
<a class="sourceLine" id="cb3-7" title="7">               <span class="dt">bl.smooth=</span><span class="dv">1</span>, <span class="dt">bl.knots=</span><span class="dv">121</span>)</a></code></pre></div>
</div>
<div id="computation" class="section level2">
<h2 class="hasAnchor">
<a href="#computation" class="anchor"></a>Computation</h2>
<p>Now we run the SMC algorithm to fit the model:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"result"</span>, <span class="dt">package =</span> <span class="st">"serrsBayes"</span>)</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="cf">if</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/exists.html">exists</a></span>(<span class="st">"result"</span>)) {</a>
<a class="sourceLine" id="cb4-3" title="3">  tm &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(result &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fitVoigtPeaksSMC.html">fitVoigtPeaksSMC</a></span>(wavenumbers, spectra, priors, <span class="dt">npart=</span><span class="dv">2000</span>))</a>
<a class="sourceLine" id="cb4-4" title="4">  result<span class="op">$</span>time &lt;-<span class="st"> </span>tm</a>
<a class="sourceLine" id="cb4-5" title="5">  <span class="kw"><a href="https://rdrr.io/r/base/save.html">save</a></span>(result, <span class="dt">file=</span><span class="st">"result.rda"</span>)</a>
<a class="sourceLine" id="cb4-6" title="6">}</a></code></pre></div>
<p>The default values for the number of particles, Markov chain steps, and learning rate can be somewhat conservative, depending on the application. Unfortunately, the new function <code>fitVoigtPeaksSMC</code> has not been parallelised yet, so it only runs on a single core. Thus, it can take a long time to fit the model with 34 peaks and 2401 wavenumbers:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/format.html">format</a></span>(result<span class="op">$</span>time[<span class="st">"elapsed"</span>]<span class="op">/</span><span class="dv">3600</span>, <span class="dt">digits=</span><span class="dv">3</span>),<span class="st">"hours for"</span>,<span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(result<span class="op">$</span>ess),<span class="st">"SMC iterations."</span>))</a>
<a class="sourceLine" id="cb5-2" title="2"><span class="co">#&gt; [1] "16.4 hours for 240 SMC iterations."</span></a></code></pre></div>
<p>The downside of choosing smaller values for these tuning parameters is that you run the risk of the SMC collapsing. The quality of the particle distribution deteriorates with each iteration, as measured by the effective sample size (ESS):</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw"><a href="https://rdrr.io/r/stats/plot.ts.html">plot.ts</a></span>(result<span class="op">$</span>ess, <span class="dt">ylab=</span><span class="st">"ESS"</span>, <span class="dt">main=</span><span class="st">"Effective Sample Size"</span>,</a>
<a class="sourceLine" id="cb6-2" title="2">        <span class="dt">xlab=</span><span class="st">"SMC iteration"</span>, <span class="dt">ylim=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(result<span class="op">$</span>ess)))</a>
<a class="sourceLine" id="cb6-3" title="3"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">h=</span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(result<span class="op">$</span>ess)<span class="op">/</span><span class="dv">2</span>, <span class="dt">col=</span><span class="dv">4</span>, <span class="dt">lty=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb6-4" title="4"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">h=</span><span class="dv">0</span>,<span class="dt">lty=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb6-5" title="5"><span class="kw"><a href="https://rdrr.io/r/stats/plot.ts.html">plot.ts</a></span>(result<span class="op">$</span>accept, <span class="dt">ylab=</span><span class="st">"accept"</span>, <span class="dt">main=</span><span class="st">"M-H Acceptance Rate"</span>,</a>
<a class="sourceLine" id="cb6-6" title="6">        <span class="dt">xlab=</span><span class="st">"SMC iteration"</span>, <span class="dt">ylim=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(result<span class="op">$</span>accept)))</a>
<a class="sourceLine" id="cb6-7" title="7"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">h=</span><span class="fl">0.234</span>, <span class="dt">col=</span><span class="dv">4</span>, <span class="dt">lty=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb6-8" title="8"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">h=</span><span class="dv">0</span>,<span class="dt">lty=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb6-9" title="9"><span class="kw"><a href="https://rdrr.io/r/stats/plot.ts.html">plot.ts</a></span>(result<span class="op">$</span>times, <span class="dt">ylab=</span><span class="st">"time (s)"</span>, <span class="dt">main=</span><span class="st">"Elapsed Time"</span>, <span class="dt">xlab=</span><span class="st">"SMC iteration"</span>)</a>
<a class="sourceLine" id="cb6-10" title="10"><span class="kw"><a href="https://rdrr.io/r/stats/plot.ts.html">plot.ts</a></span>(result<span class="op">$</span>kappa, <span class="dt">ylab=</span><span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(kappa), <span class="dt">main=</span><span class="st">"Likelihood Tempering"</span>,</a>
<a class="sourceLine" id="cb6-11" title="11">        <span class="dt">xlab=</span><span class="st">"SMC iteration"</span>)</a>
<a class="sourceLine" id="cb6-12" title="12"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">h=</span><span class="dv">0</span>,<span class="dt">lty=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb6-13" title="13"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">h=</span><span class="dv">1</span>,<span class="dt">lty=</span><span class="dv">3</span>,<span class="dt">col=</span><span class="dv">4</span>)</a></code></pre></div>
<p><img src="Introduction_files/figure-html/ess-1.png" width="288"><img src="Introduction_files/figure-html/ess-2.png" width="288"><img src="Introduction_files/figure-html/ess-3.png" width="288"><img src="Introduction_files/figure-html/ess-4.png" width="288"></p>
<p>If SMC collapses, the best solution is to increase the number of particles and run it again. Thus, choosing a conservative number to begin with is a sensible strategy. With 2000 particles and 10 M-H steps per SMC iteration, we can see from the above plots that the algorithm has converged to the target distribution. More detailed convergence diagnostics can be obtained from the genealogical history of the particles <span class="citation">(Jacob, Murray, and Rubenthaler 2015, @Lee2015)</span>, but this is not yet implemented in the R package.</p>
</div>
<div id="posterior-inference" class="section level2">
<h2 class="hasAnchor">
<a href="#posterior-inference" class="anchor"></a>Posterior Inference</h2>
<p>A subsample of particles can be used to plot the posterior distribution of the baseline and peaks:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">samp.idx &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(result<span class="op">$</span>weights), <span class="dv">50</span>, <span class="dt">prob=</span>result<span class="op">$</span>weights)</a>
<a class="sourceLine" id="cb7-2" title="2">samp.mat &lt;-<span class="st"> </span>resid.mat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="dv">0</span>,<span class="dt">nrow=</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(samp.idx), <span class="dt">ncol=</span>nWL)</a>
<a class="sourceLine" id="cb7-3" title="3">samp.sigi &lt;-<span class="st"> </span>samp.lambda &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>(<span class="dt">length=</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(samp.mat))</a>
<a class="sourceLine" id="cb7-4" title="4">spectra &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(spectra)</a>
<a class="sourceLine" id="cb7-5" title="5"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(wavenumbers, spectra[<span class="dv">1</span>,], <span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">xlab=</span><span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Raman shift (cm"</span><span class="op">^</span>{<span class="op">-</span><span class="dv">1</span>}, <span class="st">")"</span>)), <span class="dt">ylab=</span><span class="st">"Intensity (a.u.)"</span>)</a>
<a class="sourceLine" id="cb7-6" title="6"><span class="cf">for</span> (pt <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(samp.idx)) {</a>
<a class="sourceLine" id="cb7-7" title="7">  k &lt;-<span class="st"> </span>samp.idx[pt]</a>
<a class="sourceLine" id="cb7-8" title="8">  samp.mat[pt,] &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mixedVoigt.html">mixedVoigt</a></span>(result<span class="op">$</span>location[k,], result<span class="op">$</span>scale_G[k,],</a>
<a class="sourceLine" id="cb7-9" title="9">                              result<span class="op">$</span>scale_L[k,], result<span class="op">$</span>beta[k,], wavenumbers)</a>
<a class="sourceLine" id="cb7-10" title="10">  samp.sigi[pt] &lt;-<span class="st"> </span>result<span class="op">$</span>sigma</a>
<a class="sourceLine" id="cb7-11" title="11">  samp.lambda[pt] &lt;-<span class="st"> </span>result<span class="op">$</span>lambda</a>
<a class="sourceLine" id="cb7-12" title="12">  </a>
<a class="sourceLine" id="cb7-13" title="13">  Obsi &lt;-<span class="st"> </span>spectra[<span class="dv">1</span>,] <span class="op">-</span><span class="st"> </span>samp.mat[pt,]</a>
<a class="sourceLine" id="cb7-14" title="14">  g0_Cal &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(Obsi) <span class="op">*</span><span class="st"> </span>samp.lambda[pt] <span class="op">*</span><span class="st"> </span>result<span class="op">$</span>priors<span class="op">$</span>bl.precision</a>
<a class="sourceLine" id="cb7-15" title="15">  gi_Cal &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span>(result<span class="op">$</span>priors<span class="op">$</span>bl.basis) <span class="op">+</span><span class="st"> </span>g0_Cal</a>
<a class="sourceLine" id="cb7-16" title="16">  mi_Cal &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/solve.html">solve</a></span>(gi_Cal, <span class="kw"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span>(result<span class="op">$</span>priors<span class="op">$</span>bl.basis, Obsi)))</a>
<a class="sourceLine" id="cb7-17" title="17"></a>
<a class="sourceLine" id="cb7-18" title="18">  bl.est &lt;-<span class="st"> </span>result<span class="op">$</span>priors<span class="op">$</span>bl.basis <span class="op">%*%</span><span class="st"> </span>mi_Cal <span class="co"># smoothed residuals = estimated basline</span></a>
<a class="sourceLine" id="cb7-19" title="19">  <span class="kw"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(wavenumbers, bl.est, <span class="dt">col=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb7-20" title="20">  <span class="kw"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(wavenumbers, bl.est <span class="op">+</span><span class="st"> </span>samp.mat[pt,], <span class="dt">col=</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb7-21" title="21">  resid.mat[pt,] &lt;-<span class="st"> </span>Obsi <span class="op">-</span><span class="st"> </span>bl.est[,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb7-22" title="22">}</a>
<a class="sourceLine" id="cb7-23" title="23"><span class="kw"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="dt">main=</span><span class="st">"Baseline for TAMRA"</span>)</a>
<a class="sourceLine" id="cb7-24" title="24"></a>
<a class="sourceLine" id="cb7-25" title="25"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/range.html">range</a></span>(wavenumbers), <span class="kw"><a href="https://rdrr.io/r/base/range.html">range</a></span>(samp.mat), <span class="dt">type=</span><span class="st">'n'</span>, <span class="dt">xlab=</span><span class="kw"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Raman shift (cm"</span><span class="op">^</span>{<span class="op">-</span><span class="dv">1</span>}, <span class="st">")"</span>)), <span class="dt">ylab=</span><span class="st">"Intensity (a.u.)"</span>)</a>
<a class="sourceLine" id="cb7-26" title="26"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">h=</span><span class="dv">0</span>,<span class="dt">lty=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb7-27" title="27"><span class="cf">for</span> (pt <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(samp.idx)) {</a>
<a class="sourceLine" id="cb7-28" title="28">  <span class="kw"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(wavenumbers, samp.mat[pt,], <span class="dt">col=</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb7-29" title="29">}</a>
<a class="sourceLine" id="cb7-30" title="30"><span class="kw"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="dt">main=</span><span class="st">"Spectral Signature"</span>)</a></code></pre></div>
<p><img src="Introduction_files/figure-html/baseline-1.png" width="700"><img src="Introduction_files/figure-html/baseline-2.png" width="700"></p>
<p>Notice that the uncertainty in the baseline is greatest where the peaks are bunched close together, which is exactly what we would expect. This is also reflected in uncertainty of the spectral signature.</p>
<p>We can compute the Voigt parameters and the full width at half maximum (FWHM) for each peak:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">result<span class="op">$</span>voigt &lt;-<span class="st"> </span>result<span class="op">$</span>FWHM &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="dt">nrow=</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(result<span class="op">$</span>beta), <span class="dt">ncol=</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(result<span class="op">$</span>beta))</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(result<span class="op">$</span>beta)) {</a>
<a class="sourceLine" id="cb8-3" title="3">  result<span class="op">$</span>voigt[k,] &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getVoigtParam.html">getVoigtParam</a></span>(result<span class="op">$</span>scale_G[k,], result<span class="op">$</span>scale_L[k,])</a>
<a class="sourceLine" id="cb8-4" title="4">  f_G &lt;-<span class="st"> </span>result<span class="op">$</span>scale_G[k,]</a>
<a class="sourceLine" id="cb8-5" title="5">  f_L &lt;-<span class="st"> </span>result<span class="op">$</span>scale_L[k,]</a>
<a class="sourceLine" id="cb8-6" title="6">  result<span class="op">$</span>FWHM[k,] &lt;-<span class="st"> </span><span class="fl">0.5346</span><span class="op">*</span>f_L <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">0.2166</span><span class="op">*</span>f_L<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>f_G<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-7" title="7">}</a></code></pre></div>
<p>Finally, display the lower and upper 95% highest posterior density (HPD) intervals for the parameters of each peak:</p>
<table class="table">
<caption>95% highest posterior density intervals for pseudo-Voigt peaks</caption>
<thead><tr class="header">
<th align="right">Location (cm-1)</th>
<th align="right">Amplitude</th>
<th align="right">FWHM (cm-1)</th>
<th align="right">Voigt</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">[ 589; 693]</td>
<td align="right">[ 0; 339]</td>
<td align="right">[ 50; 118]</td>
<td align="right">[0.45; 0.89]</td>
</tr>
<tr class="even">
<td align="right">[ 535; 626]</td>
<td align="right">[ 21; 22807]</td>
<td align="right">[ 49; 96]</td>
<td align="right">[0.26; 0.65]</td>
</tr>
<tr class="odd">
<td align="right">[ 633; 634]</td>
<td align="right">[ 2715; 3080]</td>
<td align="right">[ 26; 32]</td>
<td align="right">[0.36; 0.63]</td>
</tr>
<tr class="even">
<td align="right">[ 618; 813]</td>
<td align="right">[ 2; 212]</td>
<td align="right">[ 43; 87]</td>
<td align="right">[0.34; 0.73]</td>
</tr>
<tr class="odd">
<td align="right">[ 724; 753]</td>
<td align="right">[ 164; 496]</td>
<td align="right">[ 43; 100]</td>
<td align="right">[0.47; 0.83]</td>
</tr>
<tr class="even">
<td align="right">[ 750; 759]</td>
<td align="right">[ 156; 679]</td>
<td align="right">[ 31; 60]</td>
<td align="right">[0.26; 0.67]</td>
</tr>
<tr class="odd">
<td align="right">[ 753; 925]</td>
<td align="right">[ 0; 222]</td>
<td align="right">[ 37; 78]</td>
<td align="right">[0.41; 0.82]</td>
</tr>
<tr class="even">
<td align="right">[ 835; 845]</td>
<td align="right">[ 149; 441]</td>
<td align="right">[ 42; 79]</td>
<td align="right">[0.22; 0.62]</td>
</tr>
<tr class="odd">
<td align="right">[ 864; 996]</td>
<td align="right">[ 0; 92]</td>
<td align="right">[ 39; 80]</td>
<td align="right">[0.40; 0.79]</td>
</tr>
<tr class="even">
<td align="right">[ 963; 974]</td>
<td align="right">[ 169; 499]</td>
<td align="right">[ 41; 81]</td>
<td align="right">[0.29; 0.76]</td>
</tr>
<tr class="odd">
<td align="right">[ 959; 1069]</td>
<td align="right">[ 17; 222]</td>
<td align="right">[ 54; 125]</td>
<td align="right">[0.36; 0.86]</td>
</tr>
<tr class="even">
<td align="right">[ 967; 1126]</td>
<td align="right">[ 3; 166]</td>
<td align="right">[ 45; 93]</td>
<td align="right">[0.30; 0.77]</td>
</tr>
<tr class="odd">
<td align="right">[1083; 1129]</td>
<td align="right">[ 38; 290]</td>
<td align="right">[ 33; 63]</td>
<td align="right">[0.31; 0.63]</td>
</tr>
<tr class="even">
<td align="right">[ 942; 1079]</td>
<td align="right">[ 3; 132]</td>
<td align="right">[ 55; 123]</td>
<td align="right">[0.44; 0.90]</td>
</tr>
<tr class="odd">
<td align="right">[1188; 1196]</td>
<td align="right">[ 253; 618]</td>
<td align="right">[ 42; 80]</td>
<td align="right">[0.24; 0.67]</td>
</tr>
<tr class="even">
<td align="right">[1140; 1147]</td>
<td align="right">[ 390; 742]</td>
<td align="right">[ 39; 88]</td>
<td align="right">[0.33; 0.70]</td>
</tr>
<tr class="odd">
<td align="right">[1223; 1224]</td>
<td align="right">[ 2294; 2716]</td>
<td align="right">[ 39; 49]</td>
<td align="right">[0.32; 0.61]</td>
</tr>
<tr class="even">
<td align="right">[1250; 1297]</td>
<td align="right">[ 5; 172]</td>
<td align="right">[ 38; 81]</td>
<td align="right">[0.28; 0.72]</td>
</tr>
<tr class="odd">
<td align="right">[1288; 1296]</td>
<td align="right">[ 426; 885]</td>
<td align="right">[ 63; 129]</td>
<td align="right">[0.14; 0.46]</td>
</tr>
<tr class="even">
<td align="right">[1236; 1349]</td>
<td align="right">[ 1; 147]</td>
<td align="right">[ 36; 78]</td>
<td align="right">[0.31; 0.72]</td>
</tr>
<tr class="odd">
<td align="right">[1359; 1360]</td>
<td align="right">[ 3057; 3714]</td>
<td align="right">[ 33; 45]</td>
<td align="right">[0.51; 0.81]</td>
</tr>
<tr class="even">
<td align="right">[1372; 1379]</td>
<td align="right">[ 677; 1326]</td>
<td align="right">[ 37; 67]</td>
<td align="right">[0.30; 0.67]</td>
</tr>
<tr class="odd">
<td align="right">[1322; 1476]</td>
<td align="right">[ 0; 124]</td>
<td align="right">[ 49; 116]</td>
<td align="right">[0.37; 0.75]</td>
</tr>
<tr class="even">
<td align="right">[1419; 1423]</td>
<td align="right">[ 981; 1503]</td>
<td align="right">[ 52; 86]</td>
<td align="right">[0.32; 0.75]</td>
</tr>
<tr class="odd">
<td align="right">[1455; 1463]</td>
<td align="right">[ 864; 1942]</td>
<td align="right">[ 60; 142]</td>
<td align="right">[0.54; 0.91]</td>
</tr>
<tr class="even">
<td align="right">[1508; 1514]</td>
<td align="right">[ 848; 1860]</td>
<td align="right">[ 29; 77]</td>
<td align="right">[0.25; 0.68]</td>
</tr>
<tr class="odd">
<td align="right">[1509; 1516]</td>
<td align="right">[ 1022; 2860]</td>
<td align="right">[ 54; 174]</td>
<td align="right">[0.37; 0.85]</td>
</tr>
<tr class="even">
<td align="right">[1538; 1539]</td>
<td align="right">[ 2875; 3471]</td>
<td align="right">[ 28; 35]</td>
<td align="right">[0.23; 0.49]</td>
</tr>
<tr class="odd">
<td align="right">[1653; 1654]</td>
<td align="right">[ 7248; 7798]</td>
<td align="right">[ 39; 44]</td>
<td align="right">[0.43; 0.62]</td>
</tr>
<tr class="even">
<td align="right">[1570; 1576]</td>
<td align="right">[ 1169; 2497]</td>
<td align="right">[ 96; 214]</td>
<td align="right">[0.41; 0.87]</td>
</tr>
<tr class="odd">
<td align="right">[1615; 1637]</td>
<td align="right">[ 415; 1344]</td>
<td align="right">[ 56; 153]</td>
<td align="right">[0.44; 0.94]</td>
</tr>
<tr class="even">
<td align="right">[1702; 1719]</td>
<td align="right">[ 356; 2384]</td>
<td align="right">[ 78; 406]</td>
<td align="right">[0.52; 0.98]</td>
</tr>
</tbody>
</table>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-DelMoral2006">
<p>Del Moral, Pierre, Arnaud Doucet, and Ajay Jasra. 2006. “Sequential Monte Carlo Samplers.” <em>J. R. Stat. Soc. Ser. B</em> 68 (3): 411–36. <a href="https://doi.org/10.1111/j.1467-9868.2006.00553.x">https://doi.org/10.1111/j.1467-9868.2006.00553.x</a>.</p>
</div>
<div id="ref-Gracie2015">
<p>Gracie, K., M. Moores, W. E. Smith, Kerry Harding, M. Girolami, D. Graham, and K. Faulds. 2016. “Preferential Attachment of Specific Fluorescent Dyes and Dye Labelled DNA Sequences in a SERS Multiplex.” <em>Anal. Chem.</em> 88 (2): 1147–53. <a href="https://doi.org/10.1021/acs.analchem.5b02776">https://doi.org/10.1021/acs.analchem.5b02776</a>.</p>
</div>
<div id="ref-Jacob2015">
<p>Jacob, Pierre E., Lawrence M. Murray, and Sylvain Rubenthaler. 2015. “Path Storage in the Particle Filter.” <em>Stat. Comput.</em> 25 (2): 487–96. <a href="https://doi.org/10.1007/s11222-013-9445-x">https://doi.org/10.1007/s11222-013-9445-x</a>.</p>
</div>
<div id="ref-Lee2015">
<p>Lee, Anthony, and Nick Whiteley. 2015. “Variance Estimation in the Particle Filter.” <em>arXiv Preprint arXiv:1509.00394 [stat.CO]</em>. <a href="https://arxiv.org/abs/1509.00394">https://arxiv.org/abs/1509.00394</a>.</p>
</div>
<div id="ref-Moores2016">
<p>Moores, M., K. Gracie, J. Carson, K. Faulds, D. Graham, and M. Girolami. 2016. “Bayesian Modelling and Quantification of Raman Spectroscopy.” <em>arXiv Preprint arXiv:1604.07299 [stat.AP]</em>. <a href="http://arxiv.org/abs/1604.07299">http://arxiv.org/abs/1604.07299</a>.</p>
</div>
<div id="ref-Ramsay2009">
<p>Ramsay, Jim O., Giles Hooker, and Spencer Graves. 2009. <em>Functional Data Analysis with R and MATLAB</em>. Use R! New York: Springer. <a href="https://doi.org/10.1007/978-0-387-98185-7">https://doi.org/10.1007/978-0-387-98185-7</a>.</p>
</div>
<div id="ref-Watanabe2005">
<p>Watanabe, Hiroyuki, Norihiko Hayazawa, Yasushi Inouye, and Satoshi Kawata. 2005. “DFT Vibrational Calculations of Rhodamine 6G Adsorbed on Silver: Analysis of Tip-Enhanced Raman Spectroscopy.” <em>J. Phys. Chem. B</em> 109 (11): 5012–20. <a href="https://doi.org/10.1021/jp045771u">https://doi.org/10.1021/jp045771u</a>.</p>
</div>
<div id="ref-Wood2017">
<p>Wood, Simon N. 2017. <em>Generalized Additive Models: An Introduction with R</em>. 2nd ed. Boca Raton, FL, USA: Chapman &amp; Hall/CRC Press. <a href="https://people.maths.bris.ac.uk/~sw15190/igam/index.html">https://people.maths.bris.ac.uk/~sw15190/igam/index.html</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#data">Data</a></li>
      <li><a href="#priors">Priors</a></li>
      <li><a href="#computation">Computation</a></li>
      <li><a href="#posterior-inference">Posterior Inference</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Matt Moores, Jake Carson, Mark Girolami, Engineering and Physical Sciences Research Council.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
